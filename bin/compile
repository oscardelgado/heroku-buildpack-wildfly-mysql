#!/usr/bin/env bash
# bin/compile <build-dir> <cache-dir> <env-dir>

# versions
MYSQL_VERSION="5.1.29"
MYSQL_SHA1="91798a4463050f61598122fe7fdc24aa196dfc0c"

BP_DIR=$(cd $(dirname $0)/..; pwd) # absolute path
BIN_DIR=$BP_DIR/bin

# parse args
BUILD_DIR=$1
CACHE_DIR=$2
ENV_DIR=$3

cd $BUILD_DIR

JBOSS_HOME=$BUILD_DIR/.jboss/wildfly-10.1.0.Final

: "${JBOSS_HOME:?You need to install Wildfly first. JBOSS_HOME environment variable not found.}"

echo "-----> Downloading mysql connector ${MYSQL_VERSION}... "
curl -O http://central.maven.org/maven2/mysql/mysql-connector-java/${MYSQL_VERSION}/mysql-connector-java-${MYSQL_VERSION}.jar
echo "-----> downloaded"
sha1sum mysql-connector-java-${MYSQL_VERSION}.jar | grep $MYSQL_SHA1 > /dev/null 2>&1
echo "-----> verified"

env
set

# 1) startup
echo "-----> Starting WildFly ... "
$JBOSS_HOME/bin/standalone.sh --admin-only &

WILDFLY_RUNNING=1

until [ $WILDFLY_RUNNING -eq 0 ]; do
	$JBOSS_HOME/bin/jboss-cli.sh --connect --command=":read-attribute(name=server-state)"
	WILDFLY_RUNNING=$?
	sleep 3
done	

# 2) create mysql module
echo "-----> create mysql module ... "
$JBOSS_HOME/bin/jboss-cli.sh --connect --command="module add --name=com.mysql.driver --resources=$BUILD_DIR/mysql-connector-java-$MYSQL_VERSION.jar --dependencies=javax.api,javax.transaction.api"

# 3) install driver
echo "-----> install JDBC driver ... "
$JBOSS_HOME/bin/jboss-cli.sh --connect --command="/subsystem=datasources/jdbc-driver=mysql:add(driver-name=mysql,driver-module-name=com.mysql.driver,driver-xa-datasource-class-name=com.mysql.jdbc.jdbc2.optional.MysqlXADataSource)"

$JBOSS_HOME/bin/jboss-cli.sh --connect --command="/subsystem=datasources:installed-drivers-list"

# 3'5 datasource
$JBOSS_HOME/bin/jboss-cli.sh --connect --controller=localhost:9990 "/subsystem=datasources/data-source=MySQLDS:add(jndi-name=java:jboss/datasources/MySQLDS, user-name="b096641c9552a0", password="41c2586c", driver-name=mysql, connection-url=jdbc:mysql://us-cdbr-iron-east-03.cleardb.net:3306/heroku_a304a837b2c7d20)"
$JBOSS_HOME/bin/jboss-cli.sh --connect --controller=localhost:9990 "/subsystem=datasources/data-source=MySQLDS:write-attribute(name=max-pool-size,value=10)"
$JBOSS_HOME/bin/jboss-cli.sh --connect --controller=localhost:9990 "/subsystem=datasources/data-source=MySQLDS:write-attribute(name=validate-on-match,value=true)"
$JBOSS_HOME/bin/jboss-cli.sh --connect --controller=localhost:9990 "/subsystem=datasources/data-source=MySQLDS:write-attribute(name=check-valid-connection-sql,value=\"select 1\")"
$JBOSS_HOME/bin/jboss-cli.sh --connect --controller=localhost:9990 "/subsystem=datasources/data-source=MySQLDS:write-attribute(name=exception-sorter-class-name,value="org.jboss.jca.adapters.jdbc.extensions.mysql.MySQLExceptionSorter")"

# 3'55 list datasources 
$JBOSS_HOME/bin/jboss-cli.sh --connect --controller=localhost:9990 "/subsystem=datasources:read-resource"

# 4) shutdown
echo "-----> shutdown WildFly ... "
$JBOSS_HOME/bin/jboss-cli.sh --connect command=:shutdown

echo "-----> done"
